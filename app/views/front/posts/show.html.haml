- content_for :playground_header_content do
  = render 'front/playground_header_content/channel_menu/simple', current_issue: @current_issue, current_post: @current_post, list_nav_params: @list_nav_params

- content_for :playground_sidebar_content do
  .supplementary-boxes{ data: { controller: ('fix-bottom-comments' if is_small_screen?) } }
    - unless is_small_screen?
      = render partial: 'front/channels/supplementary_pinned_posts', locals: @supplementary_locals, default_force: 'hide'
    - comments = @updated_comments&.any? ? @updated_comments : @recent_comments
    - if comments&.any?
      .supplementary-box{ data: { controller: "content-toggle", target: 'fix-bottom-comments.item', 'content-toggle': { id: "updated-comments-box-#{@current_post.id}", force: ('show' unless is_small_screen?) } } }
        .header{ class: ('active-phone' if @updated_comments&.any?), data: { action: 'click->content-toggle#toggle' } }
          .title
            - if @updated_comments&.any?
              %span.text-primary 이 게시물의 새 댓글
            - else
              이 게시물의 최근 댓글
            &nbsp;
            %i.fa.fa-comment-o.text-muted
          .count
            = comments.size
          .toggler
            %i.fa{ class: ('-hide' if is_small_screen?), data: { target: 'content-toggle.content' } }
        %ul.lines{ class: ('-hide' if is_small_screen?), data: { target: 'content-toggle.content fix-bottom-comments.lines' } }
          - comments.each do |comment|
            %li.updated-comment-line
              - next if comment.blinded?(current_user)
              .body
                .title
                  = link_to "##{dom_id(comment)}", class: 'hover:text-primary', data: { controller: 'smooth-anchor', action: 'click->smooth-anchor#go' } do
                    = comment.body.try(:truncate, 100)
                .footer
                  %span.nickname #{comment.user.nickname}
                  = smart_date_tag(comment.created_at)
    - if @wiki_histories.present?
      .supplementary-box{ data: { controller: "content-toggle", 'content-toggle': { id: "wiki-histories-box-#{@current_post.id}", force: ('show' unless is_small_screen?) } } }
        .header{ data: { action: 'click->content-toggle#toggle' } }
          .title
            위키 이력
          .count
            = @wiki_histories.total_count
          .toggler
            %i.fa{ class: ('-hide' if is_small_screen?), data: { target: 'content-toggle.content' } }
        %ul.lines{ class: ('-hide' if is_small_screen?), data: { target: 'content-toggle.content' } }
          - @wiki_histories.each do |wiki_history|
            %li.updated-comment-line
              .body
                .title
                  = link_to url_for(wiki_history_id: wiki_history.id, list_nav: @list_nav_params), class: 'hover:text-primary' do
                    #{static_date_f(wiki_history.created_at)}
                .footer
                  != wiki_history.activity { |user| user_subject_word(user) }

- if @list_nav_params.present?
  - back_params = { id: @list_nav_params[:issue_id], folder_id: @list_nav_params[:folder_id], page: @list_nav_params[:page], sort: @list_nav_params[:sort], filter: @list_nav_params[:filter], front_search: { q: @list_nav_params[:q] } }.compact
  - back_path = if @list_nav_params[:action] == 'channel'
    - front_channel_path(back_params)
  - elsif @list_nav_params[:action] == 'all'
    - front_all_path(back_params)
- else
  - back_path = front_channel_path(@current_post.issue)
= render 'front/pages/back', back_path: back_path

- moremenu_post_buttons = []

- if @current_post.wiki.present?
  - moremenu_post_buttons << capture do
    .dropdown-header
      #{user_subject_word(@current_post.user)} 시작한 위키입니다.
      - if @current_post.user != current_user
        %span.text-nowrap.cursor-pointer.text-primary{ data: { action: 'click->comment-form-new#open', mention: @current_post.user.nickname } } 멘션하기

- moremenu_post_buttons << capture do
  - if can?(:update, @current_post) and @current_post.wiki.blank?
    = link_to '수정', edit_front_post_path(@current_post, list_nav: @list_nav_params), class: 'dropdown-item'
  - if can?(:destroy, @current_post)
    = link_to '삭제', front_post_path(@current_post, list_nav: @list_nav_params), method: :delete, remote: true, data: { confirm: "정말 삭제하시겠습니까? 다시 복구 할 수 없습니다." }, class: 'dropdown-item'

- if @current_post.wiki.present?
  - moremenu_post_buttons << capture do
    - if @current_post.front_wiki?
      .dropdown-header
        커뮤니티 가이드 페이지에 게시된 위키입니다.
    - if can?(:coc_wiki, current_group)
      - if @current_post.front_wiki?
        = link_to coc_wiki_front_groups_path(post_id: @current_post.id, list_nav: @list_nav_params), method: :delete, remote: true, data: { disable_with: '내리는 중...' }, class: 'dropdown-item' do
          커뮤니티 가이드 설정 해제
      - else
        = link_to coc_wiki_front_groups_path(post_id: @current_post.id, list_nav: @list_nav_params), method: :post, remote: true, data: { disable_with: '게시 중...', confirm: ("이미 '#{@current_post.group.front_wiki_post.title}'게시물이 커뮤니티 가이드로 설정되어 있습니다. 정말 교체하시겠습니까?" if !@current_post.front_wiki? and @current_post.group.front_wiki_post.present?) }, class: 'dropdown-item' do
          커뮤니티 가이드로 설정하기
          %br
          %small TIP. 해당 그룹의 커뮤니티 가이드 페이지에 게시됩니다.

- moremenu_post_buttons << capture do
  - if @current_post.pinned?
    .dropdown-header
      고정된 게시글입니다.
  - if can?(:pin, @current_post)
    - if @current_post.pinned?
      = link_to unpin_front_post_path(@current_post, list_nav: @list_nav_params), method: :delete, remote: true, data: { disable_with: '...' }, class: 'dropdown-item' do
        고정 해제하기
    - else
      = link_to pin_front_post_path(@current_post, list_nav: @list_nav_params), method: :post, remote: true, data: { disable_with: '...' }, class: 'dropdown-item' do
        이 게시글을 고정하기

- post_control = capture do
  - moremenu_post_buttons.reject! { |button_group| button_group.blank? }
  - if moremenu_post_buttons.any?
    %span.dropdown{ data: { controller: 'phone-dropdown' } }
      %button.btn.btn-link.btn-sm{ "data-toggle": "dropdown" }
        %i.fa.fa-ellipsis-v
      .dropdown-menu.dropdown-menu-right
        - moremenu_post_buttons.each_with_index do |button_group, index|
          - if index != 0
            .dropdown-divider
          = button_group

- wiki_control = capture do
  - if @current_post.wiki.present?
    - if @current_wiki_history.present?
      = link_to front_post_path(@current_post, list_nav: @list_nav_params), class: 'btn btn-light btn-sm', data: { 'turbolinks-action': 'replace' } do
        현재 버전 보기
    - else
      = render 'front/wikis/controls', current_wiki: @current_post.wiki, list_nav_params: @list_nav_params

.post-box{ data: { controller: 'channel-read-emit' } }
  .post-main{ data: { controller: 'comment-form-new' } }
    = render 'front/posts/show/post_header/title', current_post: @current_post, post_control: post_control, wiki_control: wiki_control
    .post-content{ data: { controller: 'comment-form-sync' } }
      - if @current_post.wiki.blank?
        .post-meta
          %span.userimage{ data: { controller: 'content-popover', 'content-popover': { url: user_front_members_path(@current_post.user), options: h({ container: '.front-app' }.to_json) } } }
            .userimagebg{ style: "background-image: url(#{@current_post.user.image.sm.url})" }
          .desc
            %span.user{ data: { controller: 'content-popover', 'content-popover': { url: user_front_members_path(@current_post.user), options: h({ container: '.front-app' }.to_json) } } }
              %span.usernickname= @current_post.user.nickname
              %span.memberrole= @current_post.user.current_group_member&.role
            .createdat
              = smart_date_tag @current_post.created_at

          - if post_control.present?
            .moremenu
              = post_control

        .post-body
          .body
            = post_body_format @current_issue, @current_post.body
        - if @current_post.file_sources_only_image.any?
          .post-file-sources-only-image{ data: { controller: 'photoswipe justified-gallery' } }
            = render layout: 'layouts/photoswipe', locals: { file_sources: @current_post.file_sources_only_image, title: @current_post.title } do |file_source|
              %img{ src: file_source.lg_or_original_url }
        - if @current_post.file_sources_only_doc.any?
          .post-file-sources-only-doc
            - @current_post.file_sources_only_doc.each do |file_source|
              .doc{ data: { controller: 'download', download: { url: file_source.url, 'file-source-id': file_source.id, 'file-name': file_source.name }, action: 'click->download#execute' } }
                .icon
                  %i.fa.fa-floppy-o
                .body
                  %span.name= file_source.name
                  %span.size= number_to_human_size(file_source.file_size)
                .button
                  .btn.btn-sm.btn-secondary 다운로드
        - if @current_post.link_source.present?
          - if @current_post.video_source?
            .post-video-source
              .content
                = video_embed_code(@current_post, 'player')
              .site
                %a{ href: @current_post.link_source.url, target: '_blank' }
                  = @current_post.link_source.site_name.try(:upcase)
                  원글보기
                  %i.fa.fa-external-link
          - else
            %a.post-link-source{ href: @current_post.link_source.url, target: '_blank' }
              - if @current_post.link_source.has_image?
                .thumbnail{ style: "background-image: url(#{@current_post.link_source.image.md.url});" }
              .content
                .title= @current_post.link_source.title_or_url
                .body= excerpt(@current_post.link_source.body, length: (is_small_screen? ? 45 : 130))
                .site
                  = @current_post.link_source.site_name.try(:upcase)
                  원글보기

                  %i.fa.fa-external-link
        - if @current_post.poll.present?
          = render 'front/posts/show/poll', poll: @current_post.poll
        - if @current_post.survey.present?
          = render 'front/posts/show/survey', survey: @current_post.survey
      - else
        -# WIKI
        .post-wiki
          = render 'front/wikis/card', current_wiki: @current_post.wiki, list_nav_params: @list_nav_params, current_wiki_history:  @current_wiki_history

      .reactions
        .reaction
          - if user_signed_in?
            %a.link{ href: '#', data: { action: 'click->comment-form-new#open' }, class: ('-active' if @current_post.commented_by_me?) } 댓글달기
          - else
            %a.link{ href: '#', data: { action: 'sign-in-launcher#modal' } } 댓글달기

          - if @current_post.comments_count > 0
            %a.comments{ class: ('-active' if @current_post.commented_by_me?) }
              %i.fa{ class: (@current_post.commented_by_me? ? 'fa-comment' : 'fa-comment-o') }
              = trim_count(@current_post.comments_count)
        = render 'front/posts/show/upvotings/reaction', current_upvotable: @current_post

      .comments{ data: { controller: 'comment-hash', target: 'comment-form-sync.commentsContent' } }
        = render 'front/posts/show/comments', current_issue: @current_issue, current_post: @current_post




