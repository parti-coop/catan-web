- title_waypoint_toggler_uid = SecureRandom.uuid

- content_for :playground_header_content do
  .channel-menu
    .title
      .node
        = link_to "# #{@current_issue.title}", front_channel_path(@current_issue), class: 'link'
        = meta_icons(@current_issue)
      - @current_post.folder&.ancestors_and_self&.each do |folder|
        .node /
        .node
          = link_to folder.title, front_channel_path(@current_issue, folder_id: folder.id), class: 'link'
      .delimiter.node{ data: { 'waypoint-toggler-target': title_waypoint_toggler_uid } }
        \/
      .post.node{ data: { 'waypoint-toggler-target': title_waypoint_toggler_uid } }
        #{@current_post.title}
    .control
      = render 'front/channels/channel_menu/control', current_issue: @current_issue, current_folder: @current_folder
.post-box{ data: { controller: 'channel-read-emit', 'channel-read-emit': { 'channel-id': @current_issue.id, 'channel-has-unread': @current_issue.unread?(current_user).to_s, 'channel-read-at': @current_issue.read_at(current_user)&.to_i } } }
  .post-main
    .post-header{ data: { controller: 'waypoint-toggler', 'waypoint-toggler': { uid: title_waypoint_toggler_uid } } }
      %h5.title= @current_post.title
      %small.meta
        - last_stroked_text, last_stroked_at = @current_post.last_stroked_activity(with_creation: true) { |user| link_to(user_subject_word(user), smart_user_gallery_path(user)) }
        != last_stroked_text
        = date_f(last_stroked_at)
    .post-content{ data: { controller: 'comment-form-open' } }
      - if @current_post.wiki.blank?
        .post-meta
          = link_to smart_user_gallery_url(@current_post.user), class: 'userimage' do
            .userimagebg{ style: "background-image: url(#{@current_post.user.image.sm.url})" }
          .desc
            = link_to @current_post.user.nickname, smart_user_gallery_url(@current_post.user), class: 'usernickname'
            .createdat
              = date_f @current_post.created_at
          - moremenu_content = capture do
            - if can?(:update, @current_post) and @current_post.wiki.blank?
              = link_to '수정', edit_front_post_path(@current_post, folder_id: @current_folder&.id), class: 'dropdown-item'
          - if moremenu_content.present?
            .moremenu
              .dropdown
                %button.btn.btn-light.text-muted{ "data-toggle": "dropdown" }
                  %i.fa.fa-ellipsis-v
                .dropdown-menu.dropdown-menu-right
                  = moremenu_content
        .post-body
          .body
            = post_body_format @current_issue, @current_post.body
        - if @current_post.file_sources_only_image.any?
          .post-file-sources-only-image{ data: { controller: 'photoswipe justified-gallery' } }
            = render layout: 'layouts/photoswipe', locals: { file_sources: @current_post.file_sources_only_image, title: @current_post.title } do |file_source|
              %img{ src: file_source.lg_or_original_url }
        - if @current_post.file_sources_only_doc.any?
          .post-file-sources-only-doc
            - @current_post.file_sources_only_doc.each do |file_source|
              .doc{ data: { controller: 'download', download: { url: file_source.url, 'file-source-id': file_source.id, 'file-name': file_source.name }, action: 'click->download#execute' } }
                .icon
                  %i.fa.fa-floppy-o
                .body
                  %span.name= file_source.name
                  %span.size= number_to_human_size(file_source.file_size)
                .button
                  .btn.btn-sm.btn-secondary 다운로드
        - if @current_post.link_source.present?
          - if @current_post.video_source?
            .post-video-source
              .content
                = video_embed_code(@current_post, 'player')
              .site
                %a{ href: @current_post.link_source.url, target: '_blank' }
                  = @current_post.link_source.site_name.try(:upcase)
                  원글보기
                  %i.fa.fa-external-link
          - else
            %a.post-link-source{ href: @current_post.link_source.url, target: '_blank' }
              - if @current_post.link_source.has_image?
                .thumbnail{ style: "background-image: url(#{@current_post.link_source.image.md.url});" }
              .content
                .title= @current_post.link_source.title_or_url
                .body= excerpt(@current_post.link_source.body, length: (is_small_screen? ? 45 : 130))
                .site
                  = @current_post.link_source.site_name.try(:upcase)
                  원글보기

                  %i.fa.fa-external-link
        - if @current_post.poll.present?
          = render 'front/posts/show/poll', poll: @current_post.poll
      - else
        -# WIKI
        .post-wiki{ class: ('-active' if @current_post.wiki.active?) }
          = render 'front/wikis/card', current_wiki: @current_post.wiki

      .reactions
        - if user_signed_in?
          - if @current_post.upvoted_by_me?
            = link_to '공감해요', cancel_front_post_upvotes_path(@current_post, folder_id: @current_folder), method: :delete, remote: true, data: { disable_with: "진행 중..." }, class: 'btn btn-link btn-sm -active'
          - else
            = link_to '공감해요', front_post_upvotes_path(@current_post, folder_id: @current_folder), method: :post, remote: true, data: { disable_with: "진행 중..." }, class: 'btn btn-link btn-sm'
        - else
          %button.btn.btn-link.btn-sm{ data: { action: 'sign-in-launcher#modal' } } 공감해요

        - if user_signed_in?
          .btn.btn-link.btn-sm{ data: { action: 'click->comment-form-open#run' } } 댓글달기
        - else
          %button.btn.btn-link.btn-sm{ data: { action: 'sign-in-launcher#modal' } } 댓글달기

        - if @current_post.upvotes_count > 0
          %a.upvotes{ tabindex: 1, class: ('-active' if @current_post.upvoted_by_me?), data: { controller: 'content-popover', action: 'click->content-popover#click', 'content-popover': { url: users_front_post_upvotes_path(@current_post), options: h({ placement: 'bottom', container: '.front-app' }.to_json) } } }
            %i.fa{ class: (@current_post.upvoted_by_me? ? 'fa-heart' : 'fa-heart-o') }
            = @current_post.upvotes_count


      - if @current_post.comments.present?
        .post-comments
          - @current_post.comments_threaded.each do |parent_comment, child_comments|
            = render 'front/posts/show/comment', comment: parent_comment, child_comments: child_comments, current_folder: @current_folder

      = render 'front/posts/show/comment/form', current_post: @current_post, current_folder: @current_folder

  .supplementary-boxes{ id: "front-app-channel-supplementary-#{@current_issue.id}", data: { controller: 'content-loader', 'content-loader-url': supplementary_front_channel_path(@current_issue, folder_id: @current_folder, post_id: @current_post), 'turbolinks-permanent': true } }



