-# TODO 저장 전에 폼 값 확인하기
= form_with(model: [:front, current_post], local: false, html: { class: 'post-form', novalidate: true, data: { controller: 'post-form editor-form', action: "ajax:before->post-form#submit" } }) do |f|
  = hidden_field_tag :folder_id, @current_folder&.id
  = f.hidden_field :issue_id
  = f.hidden_field :has_poll, value: false, data: { target: 'post-form.hasPollField' }
  = f.hidden_field :has_survey, value: false, data: { target: 'post-form.hasSurveyField' }

  .post-meta
    = link_to smart_user_gallery_url(current_user), class: 'userimage' do
      .userimagebg{ style: "background-image: url(#{current_user.image.sm.url})" }
    .desc
      = link_to current_user.nickname, smart_user_gallery_url(current_user), class: 'usernickname'
      .createdat 지금
  .form-group
    = f.text_field :base_title, class: 'form-control', placeholder: '제목...'
  .form-group
    = f.hidden_field :body, data: { target: 'post-form.bodyField' }
    %div{ style: 'display: none', data: { target: 'editor-form.source' } }
      != f.object.body

  .form-group.filesourcesfield{ data: { target: 'post-form.fileSourcesFieldGroup' }, class: ('-active' if current_post.file_sources.any?) }
    .main
      .images{ data: { target: 'post-form.imageFileSourcesContainer' } }
        = f.fields_for :file_sources, current_post.file_sources_only_image do |ff|
          = render 'front/posts/form/file_source_field', f: ff
      .docs{ data: { target: 'post-form.docFileSourcesContainer' } }
        = f.fields_for :file_sources, current_post.file_sources_only_doc do |ff|
          = render 'front/posts/form/file_source_field', f: ff
    .footer
      .btn.btn-secondary.btn-sm{ data: { target: 'post-form.addFileSourceFieldButton', action: 'click->post-form#addFileSourceField' } }
        + 파일 추가
        %span.counter
          (
          %span{ data: { target: 'post-form.fileSourcesCounter' } }<> 0
          \/
          %span<> 20
          )
      .btn.btn-light.btn-sm.text-muted{ data: { action: 'click->post-form#closeFileSourcesFieldGroup' } } 업로드 취소

      .template{ data: { target: 'post-form.fileSourceFieldTemplate' } }
        = escape_once_block do
          = f.fields_for :file_sources, FileSource.new(), child_index: 'NEW_RECORD' do |ff|
            = render 'front/posts/form/file_source_field', f: ff
      .template{ data: { target: 'post-form.imageFileSourcePreviewTemplate' } }
        = escape_once_block do
          = render 'front/posts/form/file_source_preview', file_source: FileSource.new(), type: :image
      .template{ data: { target: 'post-form.docFileSourcePreviewTemplate' } }
        = escape_once_block do
          = render 'front/posts/form/file_source_preview', file_source: FileSource.new(), type: :doc
    .helper.text-muted
      %hr
      %span.badge.badge-secondary TIP
      최대 크기 10M 파일을 20개까지 업로드할 수 있습니다. 이미지는 드래그해서 순서를 조정할 수 있습니다.

  .form-group.pollfield{ data: { target: 'post-form.pollFieldGroup' }, class: ('-active' if current_post.poll.present?) }
    .main
      = f.fields_for :poll do |ff|
        .form-group
          = ff.label :title do
            찬반투표 제목
          = ff.text_field :title, maxlength: 100, class: 'form-control', placeholder: 'ex. 탕수육소스는 찍어먹어야합니다', data: { 'rule-required': true }
        .form-group.form-inline
          %label 진행 기간은 지금부터 &nbsp;
          = ff.select :duration_days, options_for_select([0, 1, 3, 7].map { |i| [ (i == 0 ? "계속" : "#{i}일 동안"), i] }, ff.object.duration_days), {}, class: 'form-control form-control-duration'
        .form-group
          .form-check
            = ff.check_box :hidden_intermediate_result, class: 'form-check-input'
            = ff.label :hidden_intermediate_result, '종료 될 때까지 중간 투표 집계를 숨깁니다.', class: 'form-check-label'

          .form-check
            = ff.check_box :hidden_voters, class: 'form-check-input'
            = ff.label :hidden_voters, '누가 어디에 투표했는지 익명으로 진행합니다.', class: 'form-check-label'

    .footer
      .btn.btn-light.btn-sm.text-muted{ data: { action: 'click->post-form#closePollFieldGroup' } } 찬반투표 취소
  .form-group
    %button.btn.btn-xs.btn-link{ data: { action: 'click->post-form#openFileSourcesFieldGroup'} }
      %i.fa.fa-cloud-upload
      = t('labels.new_post_file_source_button')
    %button.btn.btn-xs.btn-link{ data: { action: 'click->post-form#openPollFieldGroup'} }
      %i.fa.fa-fire
      = t('labels.new_post_poll_button')

  - if @current_issue.folders.any?
    - form_folder = current_post.persisted? ? current_post.folder : @current_folder&.id
    .form-group.form-inline.folderfield{ data: { controller: 'select-link-remote content-loader', 'content-loader-url': post_folder_field_front_channel_path(@current_issue, folder_id: form_folder&.id, form_field_name: "#{f.object_name}[folder_id]") } }

  .form-group
    = f.submit '게시', class: 'btn btn-primary btn-block', data: { disable_with: "게시 중..." }